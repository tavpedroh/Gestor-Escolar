<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Aluno</title>
</head>
<body>
    <h1>Editar Aluno</h1>

    <form id="form-editar">
        <input type="hidden" id="id" name="id">

        <label for="nome">Nome:</label><br>
        <input type="text" id="nome" name="nome" required><br><br>

        <label for="data_ingresso">Data ingresso:</label><br>
        <input type="date" id="data_ingresso" name="data_ingresso" required><br><br>

        <label for="idCurso">Curso:</label><br>
        <select id="idCurso" name="idCurso" required>
            <option value="">Selecione um curso</option>
        </select><br><br>

        <button type="submit">Atualizar</button>
    </form>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        // Carregar cursos no select
        fetch("http://localhost:8080/gestor_escolar/curso")
            .then(res => res.json())
            .then(cursos => {
                const select = document.getElementById("idCurso");
                cursos.forEach(cur => {
                    const option = document.createElement("option");
                    option.value = cur.id;
                    option.textContent = cur.nome;
                    select.appendChild(option);
                });

                // Só buscar o aluno depois que as categorias forem carregadas
                if (id) {
                    fetch(`http://localhost:8080/gestor_escolar/aluno/${id}`)
                        .then(res => {
                            if (!res.ok) throw new Error("Aluno não encontrado.");
                            return res.json();
                        })
                        .then(aluno => {
                            document.getElementById("id").value = aluno.id;
                            document.getElementById("nome").value = aluno.nome;
                            document.getElementById("data_ingresso").value = aluno.data_ingresso;
                            document.getElementById("idCurso").value = aluno.curso.id;
                        })
                        .catch(err => alert("Erro ao carregar aluno: " + err.message));
                } else {
                    alert("ID do aluno não informado na URL.");
                }
            })
            .catch(err => alert("Erro ao carregar cursos: " + err.message));

        // Submeter o formulário com PUT
        document.getElementById("form-editar").addEventListener("submit", async function(e) {
            e.preventDefault();

            const aluno = {
                id: parseInt(document.getElementById("id").value),
                nome: document.getElementById("nome").value,
                data_ingresso: parseFloat(document.getElementById("data_ingresso").value),
                curso: {
                    id: parseInt(document.getElementById("idCurso").value)
                }
            };

            const response = await fetch(`http://localhost:8080/gestor_escolar/aluno/${aluno.id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(aluno)
            });

            if (response.ok) {
                alert("Aluno atualizado com sucesso!");
                window.location.href = "/gestor_escolar/Aluno/frm/frmAlunoListar.html";
            } else {
                alert("Erro ao atualizar aluno.");
            }
        });
    </script>
</body>
</html>